#!/bin/sh

usage () {
	cat 1>&2 <<EOF
$0 [option...] [JOSM option...]
Run or update JOSM.

Options:
  -h  display this help text and exit
  -v  print the currently installed JOSM version and exit
  -d  enable debug logging (\`set -x\`)
  -t  use josm-tested instead of the default josm-latest
  -u  check for new releases and update JOSM if found
  -D  pass option '-D opt=val' to JVM
EOF
	exit 0
}

cd "$XDG_DATA_HOME/applications" || exit 1

UPDATE=
JOSM_JAR="josm-latest.jar"
JAVA=/usr/lib/jvm/openjdk21/bin/java
JAVA_OPTS="
	--module-path=$JAVAFX_LIB
	--add-modules=ALL-MODULE-PATH
	--add-exports=java.base/sun.security.action=ALL-UNNAMED
	--add-exports=java.desktop/com.sun.imageio.plugins.jpeg=ALL-UNNAMED
	--add-exports=java.desktop/com.sun.imageio.spi=ALL-UNNAMED
"

version () {
	$JAVA -jar "$JOSM_JAR" --version 2>/dev/null | cut -d' ' -f1-3
}

update () {
	OLDVER=$(version)
	echo checking for update...
	curl -o "$JOSM_JAR" -z "$JOSM_JAR" \
		"https://josm.openstreetmap.de/download/$JOSM_JAR"
	VER=$(version)
	[ "$OLDVER" = "$VER" ] && echo "No new version (already $VER)" || \
		echo "updated from ${OLDVER:-none} to $VER"
	exit 0
}

while getopts "hvdtuD:" opt; do
	case "$opt" in
		h|\?) usage ;;
		v)    version; exit 0 ;;
		d)    set -x ;;
		t)    JOSM_JAR="josm-tested.jar" ;;
		u)    UPDATE=1 ;;
		D)    JAVA_OPTS="$JAVA_OPTS -D$OPTARG" ;;
	esac
done
shift $(( OPTIND - 1 ))

[ "$UPDATE" ] && update

# if no args passed to JOSM, use default session
[ $# -eq 0 ] && set -- "$XDG_DATA_HOME/JOSM/session-default.joz"

# we want shell splitting here to pass JAVA_OPTS correctly
# shellcheck disable=2086
$JAVA $JAVA_OPTS -jar "./$JOSM_JAR" "$@"
