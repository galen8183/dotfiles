#!/bin/sh

die () {
	printf "%s\nTry '$(basename "$0") -h' for more information.\n" "$1" 1>&2
	exit 1
}

usage () {
	cat 1>&2 <<EOF
$(basename "$0") options [filename]
Record session audio and/or video with ffmpeg.

Options:
	-v          be more verbose
	-q          supress most messages
	-a          record loopback audio
	-x          record selection of X display
	-t=DURATION stop recording after DURATION
	-k          launch screenkey(1) during recording
	-r=RATE     record timelapse at PTS *= RATE
	-?          display this help and exit

At least one recording method must be specified. File formats are determined by
file extension if filename is provided, otherwise FLAC is used for audio only
recording and mp4 is used for any video recording. See ffmpeg(1) for valid
DURATION values.
EOF
	exit 0
}

OK= DEST=
ARGS="-hide_banner"

while getopts hqvaxt:kr: f; do
	case $f in
		\?) die "missing operand" ;;
		h)  usage ;;
		q)  ARGS="$ARGS -loglevel fatal" ;;
		v)  ARGS="$ARGS -loglevel level+verbose" ;;
		a)
			ARGS="$ARGS -f alsa -ac 2 -i loopin"
			ln -s "$XDG_CONFIG_HOME/alsa/asoundrc-loopback" "$XDG_CONFIG_HOME/alsa/asoundrc"
			[ -z "$DEST" ] && DEST="$HOME/media/audio/$(date +%FT%H%M%S).flac"
			OK=1
			;;
		x)
			REGION=$(slop -f "%wx%h %x,%y")
			ARGS="$ARGS -video_size ${REGION% *} -f x11grab -i :0.0+${REGION#* }"
			DEST="$HOME/media/video/rec/$(date +%FT%H%M%S).mp4"
			OK=1
			;;
		t)
			ARGS="$ARGS -t $OPTARG"
			;;
		k)
			if type screenkey >/dev/null 2>&1; then
				screenkey &
			else
				echo command "screenkey" not found, skipping option >&2
			fi
			;;
		r)
			ARGS="$ARGS -filter:v setpts=$OPTARG*PTS -r 24"
			;;
	esac
done

shift $(( OPTIND - 1 ))
[ $# -ne 0 ] && DEST="$*"

[ -z "$OK" ] && die "missing operand"

DESTDIR="$(dirname "$DEST")"
if [ ! -d "$DESTDIR" ]; then
	C="Y"
	echo "destination directory does not exist" >&2
	echo "create $DESTDIR? [Y/n]"
	read -r C
	case $C in
		Y|y) mkdir -p "$DESTDIR" ;;
		*) exit 0 ;;
	esac
fi

# shellcheck disable=2086
ffmpeg $ARGS "$DEST"

# cleanup
pkill screenkey
[ -f "$XDG_CONFIG_HOME/alsa/asoundrc" ] && rm "$XDG_CONFIG_HOME/alsa/asoundrc"

printf "%s" "$DEST" | xclip -sel clip
notify-send "Recorded to $DEST"
