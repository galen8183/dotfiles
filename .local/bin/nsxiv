#!/bin/sh
# wrapper script around nsxiv(1) to support URLs in the file list

TMPDIR="${TMPDIR:-/tmp}/$(basename "$0")"
mkdir -p "$TMPDIR"

# mkfiles writes a list of filenames to $TMPLIST from files and URLs in the
# parameter list. Options are returned in a space-separated list as passed.
# Options with arguments *must* use -a=b or --a=b, space-separation is not
# supported. The special option -- will treat all further params as files/URLs.
mkfiles() {
	noflags=0
	for param; do
		case "$param" in
			--) noflags=1; continue ;;
			-*) [ $noflags -ne 1 ] && { printf "%s " "$param"; continue; } ;;
			*://*) param="$(fetch "$param")" ;;
		esac

		printf "%s\n" "$param" >> "$TMPLIST"
	done
}

# fetch downloads media from $1, stripping size URL params if $STRIP_URL is set
# prints the output file name to stdout
fetch() {
	[ "$STRIP_URL" -eq 1 ] && set -- \
		"$(printf "%s" "$1" | sed -e 's/\([?&]\)\([wh]\|width\|height\|size\)=[0-9]\+[?&]\?/\1/g')"

	curl -L \
		--remote-name --remote-header-name \
		--output-dir "$TMPDIR" --no-clobber \
		--write-out "%{filename_effective}" \
		"$1"
}

IMG="$TMPDIR/$(date -Is)"
STRIP_URL=0

while getopts :1xu f; do
	# shellcheck disable=2220
	case "$f" in
		1) cat > "$IMG" ;;
		x) xclip -sel clip -target image/png -out > "$IMG" ;;
		u) STRIP_URL=1 ;;
	esac
done

shift $(( OPTIND - 1 ))

TMPLIST="$(mktemp -p "$TMPDIR" files.XXXXXX)"
[ -f "$IMG" ] && printf "%s\n" "$IMG" >> "$TMPLIST"

# shellcheck disable=2046
set -- $(mkfiles "$@")
/bin/nsxiv --stdin "$@" < "$TMPLIST"
rm "$TMPLIST"
